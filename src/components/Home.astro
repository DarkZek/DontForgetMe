---
import { db } from '@db/index'
import { notificationsTable } from '@db/schema'
import { eq } from 'drizzle-orm'
import { Icon } from 'astro-icon/components'
import Title from './Title.astro'

import HowItWorks1 from '../assets/HowItWorks1.svg'
import HowItWorks2 from '../assets/HowItWorks2.svg'
import HowItWorks3 from '../assets/HowItWorks3.svg'

import NotificationPermissionDialog from './NotificationPermissionDialog.astro'

const fcmToken = Astro.cookies.get('fcmToken')?.value

let subscription

if (fcmToken) {
    subscription = (await db.select().from(notificationsTable)
        .where(eq(notificationsTable.fcmToken, fcmToken))
        .limit(1))[0]
}
---

<div class="container">
    
    <div class="main-content">
        <br>
        <br>

        <Title />

        <br>

        <h3>How it works</h3>
        
        <div class="howitworks">
            <img src={HowItWorks1.src} alt="1. Enter a watering interval">
            <img src={HowItWorks2.src} alt="2. Get notified when it's watering time">
            <img src={HowItWorks3.src} alt="3. Get follow ups">
        </div>

        <br>
        <br>

        <div class="interval-selection">
            <input type="radio" id="i3" name="interval" value="3" checked>
            <label for="i3" class="option">
                <span>3</span>
                <span>DAYS</span>
            </label>

            <input type="radio" id="i4" name="interval" value="4">
            <label for="i4" class="option">
                <span>4</span>
                <span>DAYS</span>
            </label>

            <input type="radio" id="i5" name="interval" value="5">
            <label for="i5" class="option">
                <span>5</span>
                <span>DAYS</span>
            </label>

            <input type="radio" id="icustom" name="interval" value="custom">
            <label for="icustom" class="option">
                <span>CUSTOM</span>
                <span>DAYS</span>
            </label>
        </div>

        <br>

        { subscription ? (
            <p>
                <Icon name="noto:bell" size="24" />
                You're already subscribed to notifications
            </p>
            <a
                class="button plausible-event-name=Change+Interval+Click"
                href="/subscription"
            >
                <Icon name="noto:pencil" size="18" />
                Change watering interval
            </a>
        ) : (
            <button
                id="notification-trigger"
                class="plausible-event-name=Start+Reminders+Click"
            >
                Start watering reminders
            </button>
        ) }
    </div>
    <span class="quote">“Life is too short to not buy that houseplant’</span>
</div>

<NotificationPermissionDialog />

<style>

    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 800px;
        margin: auto;
        background-color: #D3FFBF;
        min-height: 100vh;
        max-width: 100vw;
        padding-bottom: 24px;

        .main-content {
            padding: 16px 16px 48px 16px;
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: calc(100% - 32px);
        }
    }

    h3 {
        text-align: center;
        color: #114C0B;
        font-size: 24px;
    }

    .howitworks {
        display: flex;
        flex-direction: row;
        gap: 16px;
        overflow: auto;
        max-width: 100%;
    }

    .interval-selection {
        display: flex;
        flex-direction: row;
        gap: 12px;

        input {
            display: none;
        }

        :checked + .option {
            outline: 4px solid #2AC834;
            color: #2AC834;
        }

        .option {
            aspect-ratio: 1;
            width: 80px;
            outline: 2px solid green;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: outline 0.15s ease-in-out;
        }
    }

    .quote {
        color: #114C0B;
    }

</style>

<script>
document.getElementById('notification-trigger')?.addEventListener('click', () => {
    const dialog = document.getElementById('notification-permission-dialog')
    dialog!.style.opacity = '1'
    dialog!.style.display = 'block'
})
</script>