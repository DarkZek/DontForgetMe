<div
    id="notification-permission-dialog"
    class="notification-permission-dialog"
>
    <div class="dialog">
        <p>
            To send you reminders we need to ask for permission to send notifications.
            Please click the button below and allow the permission.
        </p>
        <button id="allow-notifications">Allow Notifications</button>
        <br>
        <br>
        <span class="error-message"></span>
    </div>
</div>

<script>
import { requestPermission } from '../service/frontend/firebase'

const errorMessage = document.getElementById('notification-permission-dialog')?.querySelector('.error-message')

async function doPermission() {

    errorMessage!.textContent = ''

    try {
        const fcmToken = await requestPermission()

        document.cookie = `fcmToken=${fcmToken}`

        let interval = (document.querySelector('input[name="interval"]:checked') as HTMLInputElement).value

        if (interval === 'custom') {
            interval = (document.getElementById('custom-interval') as HTMLInputElement).value
        }

        const intervalDays = parseInt(interval)

        await fetch('/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                intervalSeconds: 60 * 60 * 24 * intervalDays,
            })
        })

        console.log('Successfully subscribed!')

        window.location.href = '/success'
    } catch (e: any) {
        if (e.code === 'messaging/permission-blocked') {
            errorMessage!.textContent = 'You have blocked notifications. Please allow them in your browser settings.'
        } else {
            errorMessage!.textContent = 'An error occurred. Please try again later.'
        }
    }
}

document.getElementById('allow-notifications')?.addEventListener('click', doPermission)

</script>

<style>
    .notification-permission-dialog {
        display: none;
        opacity: 0;

        position: fixed;
        inset: 0px;
        background-color: rgba(0, 0, 0, 0.5);

        @media (prefers-reduced-motion: no-preference) {
            transition: opacity 0.3s ease-in-out;
        }

        .dialog {
            padding: 20px;
            margin: auto;
            position: absolute;
            max-width: 400px;
            max-height: 200px;
            background-color: white;
            border-radius: 14px;
            inset: 0px;
        }

        .error-message {
            color: red;
        }
    }
</style>